<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安藤忠雄 - 互動學習 App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .animate-bounce-subtle {
            animation: bounceSubtle 2s infinite;
        }

        .animate-confetti {
            position: absolute;
            width: 10px;
            height: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounceSubtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BookOpen, PenTool, History, Heart, AlertCircle, CheckCircle, XCircle, 
            ChevronRight, LogOut, User, ArrowLeft, Zap, Volume2, Home, LayoutGrid, 
            Layers, ChevronDown, ChevronUp, Loader2, Sparkles, Image as ImageIcon, Download, ImageOff,
            Gavel, Scale, FileText, List, Leaf, Droplets, Tent, Mountain, PlayCircle, FastForward, RotateCcw,
            Flower, BookMarked, Hammer, Brain, Lightbulb, Info
        } from 'lucide-react';

        // --- LocalStorage Database Helper ---
        // Storage Keys Prefix: Chinese3-L11
        const STORAGE_KEYS = {
            USER: 'Chinese3-L11_user', 
            HISTORY: 'Chinese3-L11_history',
            MISTAKES: 'Chinese3-L11_mistakes',
            FAVORITES: 'Chinese3-L11_favorites',
            QUIZ_PROGRESS_FULL: 'Chinese3-L11_quiz_progress_full',
            QUIZ_PROGRESS_QUICK: 'Chinese3-L11_quiz_progress_quick'
        };

        const LocalDB = {
            getUser: () => {
                const data = localStorage.getItem(STORAGE_KEYS.USER);
                return data ? JSON.parse(data) : null;
            },
            saveUser: (name) => {
                const user = { uid: 'local-user', displayName: name, lastLogin: new Date().toISOString() };
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(user));
                return user;
            },
            clearUser: () => {
                localStorage.removeItem(STORAGE_KEYS.USER);
            },
            getHistory: () => {
                const data = localStorage.getItem(STORAGE_KEYS.HISTORY);
                return data ? JSON.parse(data) : [];
            },
            addHistory: (record) => {
                const list = LocalDB.getHistory();
                const newRecord = { ...record, id: Date.now().toString(), date: new Date().toISOString() };
                list.unshift(newRecord); 
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(list));
                return newRecord;
            },
            getMistakes: () => {
                const data = localStorage.getItem(STORAGE_KEYS.MISTAKES);
                return data ? JSON.parse(data) : [];
            },
            addMistake: (mistake) => {
                const list = LocalDB.getMistakes();
                const exists = list.some(item => item.id === mistake.id);
                if (!exists) {
                    const newMistake = { ...mistake, timestamp: new Date().toISOString() };
                    list.unshift(newMistake);
                    localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(list));
                }
            },
            removeMistake: (id) => {
                const list = LocalDB.getMistakes().filter(item => item.id.toString() !== id.toString());
                localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(list));
            },
            getFavorites: () => {
                const data = localStorage.getItem(STORAGE_KEYS.FAVORITES);
                return data ? new Set(JSON.parse(data)) : new Set();
            },
            toggleFavorite: (id) => {
                const favs = LocalDB.getFavorites();
                const idStr = id.toString();
                if (favs.has(idStr)) {
                    favs.delete(idStr);
                } else {
                    favs.add(idStr);
                }
                localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(Array.from(favs)));
                return favs;
            },
            removeFavorite: (id) => {
                const favs = LocalDB.getFavorites();
                favs.delete(id.toString());
                localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(Array.from(favs)));
            },
            // --- Quiz Progress Methods ---
            saveProgress: (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            },
            getProgress: (key) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },
            clearProgress: (key) => {
                localStorage.removeItem(key);
            }
        };
        
        // --- Global Data Definitions (安藤忠雄 Content) ---
        const STUDY_CONTENT = {
            intro: {
                title: "核心字彙與相似字 (1-3)",
                items: [
                    { term: "1. 【契】系列 (重要)", definition: "● 鍥(ㄑㄧㄝˋ)：鍥而不捨(刻，比喻堅持到底)。\n● 契(ㄑㄧˋ)：契合(投合)。\n● 楔(ㄒㄧㄝ)：楔子(序文)。\n● 喫(ㄔ)：喫茶(飲、食，同吃)。" },
                    { term: "2. 【古】系列", definition: "● 怙(ㄏㄨˋ)：怙惡不悛(堅持作惡)、失怙(父親)。\n● 估(ㄍㄨ)：估計。\n● 沽(ㄍㄨ)：待價而沽(賣)。\n● 古(ㄍㄨˇ)：人心不古(質樸)。\n● 姑(ㄍㄨ)：姑媽。\n● 辜(ㄍㄨ)：辜負(背負、虧欠)。\n● 居(ㄐㄩ)：居心叵測(存有)。" },
                    { term: "3. 【肖】系列", definition: "● 削(ㄒㄧㄠ)：削木頭(刮除表層)、被老師削了一頓(責怪)。\n● 削(ㄒㄩㄝˋ)：削地、削職(刪除)、剝削、削弱。\n● 宵(ㄒㄧㄠ)：通宵達旦(夜)。\n● 霄(ㄒㄧㄠ)：九霄雲外(天空)。\n● 銷(ㄒㄧㄠ)：撤銷(除去)。\n● 逍(ㄒㄧㄠ)：逍遙(自由自在)。" },
                ],
                special_item: {
                    term: "學習重點",
                    definition: "辨析形近字與多音字",
                    long_desc: "本單元重點在於分辨字形相似但讀音或意義不同的字。「鍥」與「契」是考試常客；「削」的多音字(ㄒㄧㄠ/ㄒㄩㄝˋ)更是語音辨正的重點。"
                }
            },
            shape_sound: {
                title: "形音義進階 (4-7)",
                items: [
                    { char: "【堯】系列 (極重要)", content: "● 撓(ㄋㄠˊ)：不屈不撓(屈服)、阻撓。\n● 僥(ㄐㄧㄠˇ)：僥倖(意外成功)。\n● 繞(ㄖㄠˋ)：圍繞。\n● 饒(ㄖㄠˊ)：饒恕、富饒(豐厚)。\n● 嬈(ㄖㄠˊ)：妖嬈(嫵媚)。\n● 蕘(ㄖㄠˊ)：薪蕘(柴草)。\n● 橈(ㄋㄠˊ)：畫舸停橈(船槳)、橈直就曲(彎曲)。\n● 曉(ㄒㄧㄠˇ)：破曉(清晨)、知曉(知道)。" },
                    { char: "【各】系列", content: "● 絡(ㄌㄨㄛˋ)：絡繹不絕(連續)。\n● 酪(ㄌㄨㄛˋ)：乳酪。\n● 烙(ㄌㄠˋ)：烙印。\n● 賂(ㄌㄨˋ)：賄賂。\n● 客(ㄎㄜˋ)：顧客。\n● 恪(ㄎㄜˋ)：恪守(謹慎誠敬)。\n● 落(ㄌㄨㄛˋ)：家道中落(衰敗)。" },
                    { char: "【睪】系列", content: "● 繹(ㄧˋ)：絡繹、演繹。\n● 擇(ㄗㄜˊ)：選擇。\n● 澤(ㄗㄜˊ)：沼澤、恩澤。\n● 譯(ㄧˋ)：翻譯。\n● 驛(ㄧˋ)：驛站(休息處)。" },
                    { char: "多音字辨析", content: "● 朝：(ㄔㄠˊ)朝聖、朝廷 / (ㄓㄠ)朝氣、有朝一日。\n● 露：(ㄌㄨˋ)露水、顯露 / (ㄌㄡˋ)露口風。\n● 逮：(ㄉㄞˋ)逮捕、力有未逮(及)。" }
                ],
                confusing: [
                    { text: "綻 / 沉", sounds: "綻(ㄓㄢˋ)放 / 沉(ㄔㄣˊ)澱" },
                    { text: "秉 / 炳", sounds: "秉(ㄅㄧㄥˇ)持 / 炳(ㄅㄧㄥˇ)燭" },
                    { text: "咎 / 究", sounds: "咎(ㄐㄧㄡˋ)由自取 / 研(ㄐㄧㄡˋ)究" },
                    { text: "遭 / 周", sounds: "遭(ㄗㄠ)遇 / 周(ㄓㄡ)遭" }
                ]
            },
            idioms: {
                title: "重要詞語與成語",
                hope: [
                    { name: "名聞遐邇", mean: "近義：遠近馳名 ↔ 反義：默默無聞。" },
                    { name: "微乎其微", mean: "近義：微不足道 ↔ 反義：舉足輕重。形容非常微小。" },
                    { name: "鍥而不捨", mean: "近義：持之以恆 ↔ 反義：半途而廢。指不斷刻下去而不停止，比喻堅持到底。" },
                    { name: "屢戰屢敗", mean: "↔ 反義：戰無不勝。每次打仗都失敗，但也暗示持續嘗試。" },
                    { name: "嶄露頭角", mean: "近義：嶄露鋒芒 ↔ 反義：韜光養晦。比喻顯示特出的才華或本領。" },
                    { name: "聲名大噪", mean: "近義：名聞遐邇。聲望名氣大為提高。" }
                ],
                tree: [
                    { name: "絡繹不絕", mean: "義近：川流不息、接踵而至。形容行人車馬來往頻繁，連續不斷。" },
                    { name: "一望無際", mean: "一眼望去看不著邊際。形容寬廣、遼闊。" },
                    { name: "不屈不撓", mean: "義近：百折不撓。不因為受阻礙而屈服。" },
                    { name: "筋疲力竭", mean: "形容非常疲倦。" }
                ],
                analysis: [
                    { name: "懵懂", mean: "義近：糊塗 ↔ 義反：明白。形容心裡不明白。" },
                    { name: "央求", mean: "義近：懇求、請求。請求人家幫忙。" }
                ]
            },
            knowledge: {
                title: "課文結構：安藤忠雄",
                concepts: [
                    { title: "核心主旨", source: "文章核心", content: "敘述安藤忠雄在立定志向後，如何憑藉熱情與意志力，跨越學歷與經濟障礙，朝夢想前進。期勉讀者秉持熱情、自強不息。" },
                    { title: "第一部分：懵懂時期", source: "結構分析", content: "從興趣中找到夢想。隱約察覺對建築喜愛 -> 想進木工廠遭反對 -> 轉讀高工機械科 -> 開始自學 -> 為看建築考拳擊執照。" },
                    { title: "第二部分：青年時期", source: "結構分析", content: "孤獨一人，也要讓夢想開花。因經濟因素無法念大學，透過「工作」與「自修苦讀」繼續追夢。" },
                    { title: "第三部分：壯遊時期", source: "結構分析", content: "旅行，成就了建築家。踏上國際長途旅程，親身體會世界建築鉅作（水平與垂直的體驗）。" },
                    { title: "第四部分：創業初期", source: "結構分析", content: "有一就會有十。創業初期慘澹，但秉持信念。提案屢戰屢敗仍鍥而不捨。強調機會要自己創造，必須一直發聲。" },
                    { title: "第五部分：成名之後", source: "結構分析", content: "不斷參與國際競圖。獲普立茲克獎後不自滿，渴望進步與對話。將競圖當作「磨鍊思考的拳擊場」。" }
                ],
                examples: [
                    { title: "學歷與夢想", content: "對比日本學歷至上的社會，安藤是例外。他在青春期就找到志向，凸顯其特立獨行。" },
                    { title: "行動力與犧牲", content: "為了出國看建築，只花了兩個多月練習就拿到職業拳擊賽執照，顯示為圓夢全力以赴。" }
                ],
                techniques: [
                    { title: "順敘法", content: "本文採用時間順序，從童年、青年、壯遊、創業到成名。" },
                    { title: "勵志性質", content: "透過名人傳記的形式，傳達「有志者事竟成」的道理。" }
                ]
            },
            structure: {
                title: "修辭與佳句鑑賞",
                parts: [
                    { section: "轉化", title: "形象化描寫", content: "「孤獨一人，也要讓夢想開花。」(將夢想比作植物)\n「全世界的建築鉅作都跳出教科書，成為他的老師。」(擬人)" },
                    { section: "映襯", title: "強烈對比", content: "「康莊大道上綻放許多花朵，但是，我一個人卻走著這條大家都看不見的路...」\n對比主流與非主流的道路。" },
                    { section: "設問", title: "激發思考", content: "「你沒受過正規的教育，怎麼能成為一個建築家？」(激問/提問)\n「如果不是做建築家，你會做什麼呢？」" },
                    { section: "引用", title: "加強說服力", content: "「他深信一句日本諺語：『只要有一，就會有十』。」" },
                    { section: "類疊", title: "強調語氣", content: "「如果你有一個想法，你必須要一直說，一直說。」\n「他渴望進步，渴望對話。」" },
                    { section: "譬喻", title: "隱喻手法", content: "「他把每一次筋疲力竭的競圖當作磨鍊思考...的拳擊場。」(將競圖比喻為拳擊場)" }
                ]
            }
        };

        const generateQuestions = () => {
            const q = [];
            let id = 1;
            
            // --- 1. 字形字音 (40題 - 完整覆蓋) ---
            q.push({ id: id++, category: "形音義", question: "「鍥」而不捨的讀音是？", options: ["ㄑㄧㄝˋ", "ㄑㄧˋ", "ㄒㄧㄝ", "ㄐㄧㄝ"], answer: "ㄑㄧㄝˋ", explanation: "「鍥」音ㄑㄧㄝˋ，意為鏤刻。注意不可讀為ㄑㄧˋ(契)。" });
            q.push({ id: id++, category: "形音義", question: "「契」合的讀音是？", options: ["ㄑㄧˋ", "ㄑㄧㄝˋ", "ㄐㄧㄝ", "ㄒㄧㄝ"], answer: "ㄑㄧˋ", explanation: "「契」音ㄑㄧˋ，意為投合。如：默契、契合。" });
            q.push({ id: id++, category: "形音義", question: "「楔」子的讀音是？", options: ["ㄒㄧㄝ", "ㄑㄧˋ", "ㄑㄧㄝˋ", "ㄔ"], answer: "ㄒㄧㄝ", explanation: "「楔」音ㄒㄧㄝ，楔子指小說前的序文，或填充空隙的木片。" });
            q.push({ id: id++, category: "形音義", question: "「喫」茶的意思同於？", options: ["吃", "喝", "看", "買"], answer: "吃", explanation: "「喫」音ㄔ，同「吃」，意為飲、食。" });
            q.push({ id: id++, category: "形音義", question: "「怙」惡不悛的讀音是？", options: ["ㄏㄨˋ", "ㄍㄨ", "ㄎㄨ", "ㄐㄩ"], answer: "ㄏㄨˋ", explanation: "「怙」音ㄏㄨˋ，依靠的意思。怙惡不悛指堅持作惡不肯悔改。" });
            q.push({ id: id++, category: "形音義", question: "待價而「沽」的意思是？", options: ["賣", "買", "估計", "等待"], answer: "賣", explanation: "「沽」音ㄍㄨ，意思是賣。待價而沽比喻人等待機會，為世所用。" });
            q.push({ id: id++, category: "形音義", question: "人心不「古」的意思是？", options: ["質樸", "古代", "老舊", "固執"], answer: "質樸", explanation: "古：古樸、質樸。人心不古感嘆今人心地奸詐，不如古人忠厚質樸。" });
            q.push({ id: id++, category: "形音義", question: "居心「叵」測的意思是？", options: ["不可(險惡)", "可以", "困難", "容易"], answer: "不可(險惡)", explanation: "「叵」音ㄆㄛˇ，意思是「不可」。居心叵測指心存險惡，難以預測。" });
            q.push({ id: id++, category: "形音義", question: "「削」足適履的「削」讀音？", options: ["ㄒㄩㄝˋ", "ㄒㄧㄠ", "ㄕㄠ", "ㄒㄧㄠˇ"], answer: "ㄒㄩㄝˋ", explanation: "「削」讀ㄒㄩㄝˋ時多用於複合詞，如削足適履、剝削、削弱。" });
            q.push({ id: id++, category: "形音義", question: "被老師「削」了一頓的讀音是？", options: ["ㄒㄧㄠ", "ㄒㄩㄝˋ", "ㄕㄠ", "ㄙㄨㄛ"], answer: "ㄒㄧㄠ", explanation: "「削」讀ㄒㄧㄠ時多為口語或動作用詞，如削鉛筆、削了一頓(責罵)。" });
            q.push({ id: id++, category: "形音義", question: "通「宵」達旦的意思是？", options: ["夜晚", "天空", "雲氣", "除去"], answer: "夜晚", explanation: "「宵」音ㄒㄧㄠ，指夜晚。如：元宵、春宵。" });
            q.push({ id: id++, category: "形音義", question: "九「霄」雲外的意思是？", options: ["天空", "夜晚", "仙境", "遠方"], answer: "天空", explanation: "「霄」音ㄒㄧㄠ，指天空、雲氣。如：雲霄飛車、衝上雲霄。" });
            q.push({ id: id++, category: "形音義", question: "不屈不「撓」的讀音是？", options: ["ㄋㄠˊ", "ㄖㄠˊ", "ㄐㄧㄠˇ", "ㄒㄧㄠˇ"], answer: "ㄋㄠˊ", explanation: "「撓」音ㄋㄠˊ，意為彎曲、屈服。不屈不撓指不因為受阻礙而屈服。" });
            q.push({ id: id++, category: "形音義", question: "「僥」倖的讀音是？", options: ["ㄐㄧㄠˇ", "ㄋㄠˊ", "ㄖㄠˊ", "ㄧㄠ"], answer: "ㄐㄧㄠˇ", explanation: "「僥」音ㄐㄧㄠˇ。僥倖指意外獲得成功或免去災禍。" });
            q.push({ id: id++, category: "形音義", question: "富「饒」的意思是？", options: ["豐厚", "寬恕", "彎曲", "柴草"], answer: "豐厚", explanation: "「饒」音ㄖㄠˊ，意為豐厚、富足。如：富饒、豐饒。" });
            q.push({ id: id++, category: "形音義", question: "妖「嬈」的讀音是？", options: ["ㄖㄠˊ", "ㄋㄠˊ", "ㄐㄧㄠˇ", "ㄒㄧㄠ"], answer: "ㄖㄠˊ", explanation: "「嬈」音ㄖㄠˊ，意為嬌媚、嫵媚。如：妖嬈。" });
            q.push({ id: id++, category: "形音義", question: "「恪」守規定的讀音是？", options: ["ㄎㄜˋ", "ㄍㄜˋ", "ㄌㄨㄛˋ", "ㄑㄩㄝˋ"], answer: "ㄎㄜˋ", explanation: "「恪」音ㄎㄜˋ，意為謹慎誠敬。如：恪守、恪遵。" });
            q.push({ id: id++, category: "形音義", question: "「絡」繹不絕的讀音是？", options: ["ㄌㄨㄛˋ", "ㄍㄜˋ", "ㄎㄜˋ", "ㄌㄠˋ"], answer: "ㄌㄨㄛˋ", explanation: "「絡」音ㄌㄨㄛˋ。絡繹不絕形容連續不斷。" });
            q.push({ id: id++, category: "形音義", question: "「驛」站的讀音是？", options: ["ㄧˋ", "ㄗㄜˊ", "ㄕˋ", "ㄔㄜ"], answer: "ㄧˋ", explanation: "「驛」音ㄧˋ，古代供傳遞公文或休息換馬的地方。" });
            q.push({ id: id++, category: "形音義", question: "力有未「逮」的意思是？", options: ["及、趕上", "捉拿", "等待", "思考"], answer: "及、趕上", explanation: "「逮」音ㄉㄞˋ，意為及、趕上。力有未逮指能力有所不及。" });
            q.push({ id: id++, category: "形音義", question: "「估」計的讀音是？", options: ["ㄍㄨ", "ㄍㄨˇ", "ㄏㄨˋ", "ㄐㄩ"], answer: "ㄍㄨ", explanation: "「估」音ㄍㄨ，意為評定、推算。如：評估、估價。" });
            q.push({ id: id++, category: "形音義", question: "「辜」負的意思是？", options: ["背負、虧欠", "犯罪", "死亡", "孤單"], answer: "背負、虧欠", explanation: "「辜」音ㄍㄨ，意為背負、違背。如：辜負、無辜。" });
            q.push({ id: id++, category: "形音義", question: "「楔」子的意思是指？", options: ["小說前的序文", "木工工具", "契約", "鞋子"], answer: "小說前的序文", explanation: "「楔」音ㄒㄧㄝ。楔子本指填充縫隙的小木片，引申為小說戲曲的序文。" });
            q.push({ id: id++, category: "形音義", question: "撤「銷」是指？", options: ["除去", "銷售", "熔化", "夜晚"], answer: "除去", explanation: "「銷」音ㄒㄧㄠ，意為除去、解除。如：撤銷、註銷。" });
            q.push({ id: id++, category: "形音義", question: "「逍」遙的意思是？", options: ["自由自在", "快速", "消失", "走路"], answer: "自由自在", explanation: "「逍」音ㄒㄧㄠ。逍遙指自由自在，不受拘束。" });
            q.push({ id: id++, category: "形音義", question: "抓耳「撓」腮的意思是？", options: ["抓、搔", "彎曲", "阻礙", "攪擾"], answer: "抓、搔", explanation: "「撓」音ㄋㄠˊ，此處意為抓、搔癢。形容焦急或不知所措的樣子。" });
            q.push({ id: id++, category: "形音義", question: "薪「蕘」的意思是？", options: ["燃燒用的柴草", "富足", "妖媚", "彎曲"], answer: "燃燒用的柴草", explanation: "「蕘」音ㄖㄠˊ，指燃燒用的柴草。" });
            q.push({ id: id++, category: "形音義", question: "畫舸停「橈」的意思是？", options: ["船槳", "彎曲", "阻礙", "木頭"], answer: "船槳", explanation: "「橈」音ㄋㄠˊ，指船槳。" });
            q.push({ id: id++, category: "形音義", question: "家喻戶「曉」的意思是？", options: ["知道、明白", "天亮", "早晨", "告知"], answer: "知道、明白", explanation: "「曉」音ㄒㄧㄠˇ，意為知道。家喻戶曉指家家戶戶都知道。" });
            q.push({ id: id++, category: "形音義", question: "乳「酪」的讀音是？", options: ["ㄌㄨㄛˋ", "ㄌㄠˋ", "ㄍㄜˋ", "ㄎㄜˋ"], answer: "ㄌㄨㄛˋ", explanation: "「酪」音ㄌㄨㄛˋ。如：乳酪、奶酪。" });
            q.push({ id: id++, category: "形音義", question: "「烙」印的讀音是？", options: ["ㄌㄠˋ", "ㄌㄨㄛˋ", "ㄌㄨˋ", "ㄍㄜˋ"], answer: "ㄌㄠˋ", explanation: "「烙」音ㄌㄠˋ。用高溫燒燙。" });
            q.push({ id: id++, category: "形音義", question: "賄「賂」的讀音是？", options: ["ㄌㄨˋ", "ㄌㄨㄛˋ", "ㄍㄜˋ", "ㄅㄟˋ"], answer: "ㄌㄨˋ", explanation: "「賂」音ㄌㄨˋ。賄賂指行賄。" });
            q.push({ id: id++, category: "形音義", question: "尋「繹」的意思是？", options: ["理出頭緒，推究事理", "連續不斷", "翻譯", "選擇"], answer: "理出頭緒，推究事理", explanation: "「繹」音ㄧˋ，尋繹意為推究事理，理出頭緒。" });
            q.push({ id: id++, category: "形音義", question: "恩「澤」的意思是？", options: ["恩惠", "水流匯聚處", "光彩", "選擇"], answer: "恩惠", explanation: "「澤」音ㄗㄜˊ，本義為水流匯聚處，引申為恩惠。" });
            q.push({ id: id++, category: "形音義", question: "「朝」聖的讀音是？", options: ["ㄔㄠˊ", "ㄓㄠ", "ㄔㄠ", "ㄓㄠˊ"], answer: "ㄔㄠˊ", explanation: "「朝」讀ㄔㄠˊ時，指朝見、向著。如：朝聖、朝廷。" });
            q.push({ id: id++, category: "形音義", question: "有「朝」一日的讀音是？", options: ["ㄓㄠ", "ㄔㄠˊ", "ㄔㄠ", "ㄓㄠˊ"], answer: "ㄓㄠ", explanation: "「朝」讀ㄓㄠ時，指早晨、日子。如：朝氣、今朝。" });
            q.push({ id: id++, category: "形音義", question: "「綻」放的讀音是？", options: ["ㄓㄢˋ", "ㄉㄧㄥˋ", "ㄔㄣˊ", "ㄒㄧㄢˋ"], answer: "ㄓㄢˋ", explanation: "「綻」音ㄓㄢˋ，指花蕾吐放或裂開。如：皮開肉綻。" });
            q.push({ id: id++, category: "形音義", question: "「秉」燭夜遊的讀音是？", options: ["ㄅㄧㄥˇ", "ㄅㄧㄥ", "ㄆㄧㄥˊ", "ㄐㄧㄢ"], answer: "ㄅㄧㄥˇ", explanation: "「秉」音ㄅㄧㄥˇ，意為拿著、握著。" });
            q.push({ id: id++, category: "形音義", question: "「咎」由自取的讀音是？", options: ["ㄐㄧㄡˋ", "ㄐㄧㄡ", "ㄍㄜˋ", "ㄔㄨˋ"], answer: "ㄐㄧㄡˋ", explanation: "「咎」音ㄐㄧㄡˋ，意為災禍、罪過。" });
            q.push({ id: id++, category: "形音義", question: "周「遭」的意思是？", options: ["周圍", "遇見", "遭受", "次數"], answer: "周圍", explanation: "「遭」音ㄗㄠ。周遭意指周圍。" });

            // --- 2. 成語與詞語 (20題 - 增加反義與釋義) ---
            q.push({ id: id++, category: "成語", question: "「名聞遐邇」的近義詞是？", options: ["遠近馳名", "默默無聞", "惡名昭彰", "不見經傳"], answer: "遠近馳名", explanation: "名聞遐邇形容名聲傳播得很遠。近義詞為遠近馳名。" });
            q.push({ id: id++, category: "成語", question: "「鍥而不捨」比喻？", options: ["堅持到底", "刻印章", "捨棄不顧", "做事果斷"], answer: "堅持到底", explanation: "鍥：鏤刻；捨：停止。不斷鏤刻而不停止，比喻堅持到底，奮勉不懈。" });
            q.push({ id: id++, category: "成語", question: "「屢戰屢敗」的反義詞是？", options: ["戰無不勝", "一敗塗地", "棄甲曳兵", "潰不成軍"], answer: "戰無不勝", explanation: "屢戰屢敗指每次打仗都失敗。反義詞為戰無不勝（攻無不克）。" });
            q.push({ id: id++, category: "成語", question: "「嶄露頭角」形容？", options: ["顯示特出的才華", "頭上長角", "隱藏實力", "剛起床的樣子"], answer: "顯示特出的才華", explanation: "嶄露頭角比喻顯示特出的才華或本領。" });
            q.push({ id: id++, category: "成語", question: "「韜光養晦」是哪句成語的反義詞？", options: ["嶄露頭角", "虛懷若谷", "大智若愚", "深藏不露"], answer: "嶄露頭角", explanation: "韜光養晦比喻隱藏才智，不使外露。是「嶄露頭角」的反義詞。" });
            q.push({ id: id++, category: "成語", question: "「絡繹不絕」形容？", options: ["連續不斷", "交通阻塞", "聲音很大", "繩子很長"], answer: "連續不斷", explanation: "絡繹不絕形容行人車馬來往頻繁，連續不斷。" });
            q.push({ id: id++, category: "成語", question: "「一望無際」形容？", options: ["寬廣遼闊", "視力模糊", "沒有希望", "邊界很近"], answer: "寬廣遼闊", explanation: "一望無際指一眼望去看不著邊際，形容寬廣、遼闊。" });
            q.push({ id: id++, category: "成語", question: "「懵懂」的意思接近？", options: ["糊塗", "明白", "聰明", "懂事"], answer: "糊塗", explanation: "懵懂形容心裡不明白、糊塗。" });
            q.push({ id: id++, category: "成語", question: "「怙惡不悛」是指？", options: ["堅持作惡不悔改", "父親去世", "惡人有惡報", "雖然作惡但會改"], answer: "堅持作惡不悔改", explanation: "怙：依靠；悛：悔改。依靠某種勢力，堅持作惡，不肯悔改。" });
            q.push({ id: id++, category: "成語", question: "「居心叵測」的意思是？", options: ["存心險惡，難以推測", "心地善良", "心思細膩", "居住環境不好"], answer: "存心險惡，難以推測", explanation: "叵：不可。居心叵測指心存險惡，難以推測。" });
            q.push({ id: id++, category: "成語", question: "「微乎其微」形容？", options: ["非常微小", "非常重要", "微妙的關係", "危險"], answer: "非常微小", explanation: "微乎其微形容非常微小，不重要。" });
            q.push({ id: id++, category: "成語", question: "「待價而沽」原本是指賣什麼？", options: ["貨物(比喻懷才待用)", "土地", "股票", "古董"], answer: "貨物(比喻懷才待用)", explanation: "沽：賣。原指等待好價錢才賣出。後比喻人等待機會，為世所用。" });
            q.push({ id: id++, category: "成語", question: "「九霄雲外」通常用來形容？", options: ["拋在極遠的地方", "飛機飛很高", "天氣很好", "神仙住的地方"], answer: "拋在極遠的地方", explanation: "九霄雲外形容極高的天空。常形容將事物拋在極遠的地方，完全不放在心上。" });
            q.push({ id: id++, category: "成語", question: "「家道中落」的意思是？", options: ["家境衰敗", "搬家", "家中有人跌倒", "蓋房子"], answer: "家境衰敗", explanation: "家道中落指家境由富轉貧，走向衰敗。" });
            q.push({ id: id++, category: "成語", question: "「央求」的意思是？", options: ["懇求", "要求", "命令", "答應"], answer: "懇求", explanation: "央求即懇求、請求。" });
            q.push({ id: id++, category: "成語", question: "「微乎其微」的反義詞是？", options: ["舉足輕重", "微不足道", "滄海一粟", "九牛一毛"], answer: "舉足輕重", explanation: "微乎其微指極小；舉足輕重指非常重要，足以影響全局。" });
            q.push({ id: id++, category: "成語", question: "「名聞遐邇」的反義詞是？", options: ["默默無聞", "聲名大噪", "家喻戶曉", "遠近馳名"], answer: "默默無聞", explanation: "名聞遐邇指名氣大；默默無聞指沒有名氣。" });
            q.push({ id: id++, category: "成語", question: "「聲名大噪」的意思是？", options: ["聲望名氣大為提高", "聲音很大", "吵鬧不休", "名聲掃地"], answer: "聲望名氣大為提高", explanation: "聲名大噪指聲望名氣大為提高。" });
            q.push({ id: id++, category: "成語", question: "「不屈不撓」的意思接近？", options: ["百折不撓", "卑躬屈膝", "委曲求全", "撓癢癢"], answer: "百折不撓", explanation: "不屈不撓指不因為受阻礙而屈服。近義詞為百折不撓。" });
            q.push({ id: id++, category: "成語", question: "「筋疲力竭」的意思是？", options: ["形容非常疲倦", "力大無窮", "精神抖擻", "筋骨受傷"], answer: "形容非常疲倦", explanation: "筋疲力竭形容非常疲倦，力氣用盡。" });

            // --- 3. 課文理解 (安藤忠雄) (30題 - 深度解析) ---
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄年輕時為了出國看建築，考取了什麼執照？", options: ["職業拳擊手", "木工", "導遊", "船員"], answer: "職業拳擊手", explanation: "安藤忠雄為了出國看建築，在短時間內練習並考取職業拳擊手執照，以便出國比賽順便看建築。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄的學習建築方式主要是？", options: ["自學", "大學建築系", "出國留學", "補習班"], answer: "自學", explanation: "安藤忠雄因經濟因素無法念大學，他透過閱讀、旅行和實作「自學」建築。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄深信哪句日本諺語？", options: ["有一就會有十", "失敗為成功之母", "一期一會", "坐而言不如起而行"], answer: "有一就會有十", explanation: "安藤深信「只要有一，就會有十」，意思是萬事起頭難，只要能創造第一個機會，後續的機會就會接踵而至。" });
            q.push({ id: id++, category: "課文解析", question: "文中提到安藤忠雄將競圖比喻為？", options: ["拳擊場", "戰場", "賭場", "遊樂場"], answer: "拳擊場", explanation: "安藤將競圖比喻為「磨鍊思考、激發潛力、觀摩交流的拳擊場」，呼應他曾是拳擊手的經歷。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄認為邁向夢想的道路？", options: ["有很多途徑", "只有一條", "必須有學歷", "全靠運氣"], answer: "有很多途徑", explanation: "課文提到：「他清楚地知道夢想只有一個，但是，邁向夢想的道路卻有很多途徑。」" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄透過旅行親身體驗了建築的？", options: ["水平與垂直", "價格與成本", "歷史與文化", "顏色與裝飾"], answer: "水平與垂直", explanation: "安藤在旅行中親身體驗了建築的「水平」（如大海）與「垂直」，獲得比課本更直接的感受。" });
            q.push({ id: id++, category: "課文解析", question: "「孤獨一人，也要讓夢想開花」運用了什麼修辭？", options: ["轉化", "誇飾", "借代", "排比"], answer: "轉化", explanation: "將抽象的「夢想」比作可以「開花」的植物，屬於轉化修辭中的形象化。" });
            q.push({ id: id++, category: "課文解析", question: "「康莊大道」與「看不見的路」使用了什麼修辭技巧？", options: ["映襯", "類疊", "層遞", "互文"], answer: "映襯", explanation: "以眾人走的「康莊大道」（主流升學路）對比自己走的「看不見的路」（自學路），形成映襯。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄成名後面臨的挑戰主要是？", options: ["學歷遭受質疑", "沒有靈感", "經濟破產", "健康亮紅燈"], answer: "學歷遭受質疑", explanation: "即使成名並受邀至東大任教，日本社會仍拿他高工畢業的學歷做文章。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄如何面對沒有案子的時期？", options: ["讀書或去空地思考", "去打拳擊", "出國旅遊", "抱怨社會"], answer: "讀書或去空地思考", explanation: "在沒有案子的時候，他堅持讀書，或是到戶外空地設身處地思考，鍛鍊思考能力。" });
            q.push({ id: id++, category: "課文解析", question: "這篇文章主要採用什麼寫作結構？", options: ["順敘法", "倒敘法", "插敘法", "補敘法"], answer: "順敘法", explanation: "文章依時間順序，從童年、青年、壯遊、創業到成名，屬於順敘法。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄認為如果有一個想法，必須要？", options: ["一直說，一直說", "藏在心裡", "寫成書", "申請專利"], answer: "一直說，一直說", explanation: "安藤強調機會要自己創造，必須不斷發聲，直到說服別人。" });
            q.push({ id: id++, category: "課文解析", question: "「全世界的建築鉅作都跳出教科書，成為他的老師」使用了什麼修辭？", options: ["轉化(擬人)", "譬喻", "誇飾", "引用"], answer: "轉化(擬人)", explanation: "將建築鉅作比擬為會教導他的「老師」，屬於轉化中的擬人法。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄小時候原本想從事什麼工作遭家人反對？", options: ["木工", "拳擊手", "機械工", "畫家"], answer: "木工", explanation: "安藤小時候看著鄰居蓋房子，原本想進木工工廠，但遭外婆與家人反對。" });
            q.push({ id: id++, category: "課文解析", question: "文末提到安藤忠雄獲獎後的心態是？", options: ["渴望進步與對話", "退休養老", "批評後進", "不再參加比賽"], answer: "渴望進步與對話", explanation: "安藤獲獎後不自滿，依然渴望進步與對話，因此數度參與國際競圖。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄第一次興起從事建築業的夢想，是因為？", options: ["看著加蓋小屋完成", "看到宏偉的教堂", "讀了建築雜誌", "參觀了博物館"], answer: "看著加蓋小屋完成", explanation: "14歲時，看著年輕木匠為他家蓋了一個7坪大的加蓋小屋，深受感動而興起夢想。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄因為家人反對做木工，轉而就讀什麼科系？", options: ["高工機械科", "高中普通科", "高職美工科", "五專土木科"], answer: "高工機械科", explanation: "家人反對他做木工，他於是轉念高工機械科，並開始自學建築。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄只花了多久時間就拿到職業拳擊手執照？", options: ["兩個多月", "兩年", "兩週", "半年"], answer: "兩個多月", explanation: "為了出國，他展現驚人的行動力，只花兩個多月練習就考取執照。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄為什麼無法進大學念建築？", options: ["經濟因素", "成績太差", "不想念書", "學校不收"], answer: "經濟因素", explanation: "雖然家人不反對，但因家境經濟因素，無法負擔大學學費。" });
            q.push({ id: id++, category: "課文解析", question: "「康莊大道」在文中比喻什麼？", options: ["主流、學歷至上的路", "寬闊的馬路", "充滿花朵的路", "通往成功的捷徑"], answer: "主流、學歷至上的路", explanation: "康莊大道比喻日本社會主流的、依循學歷體制的成功路徑。" });
            q.push({ id: id++, category: "課文解析", question: "「我對自己說，我要讓這條路也能開花結果」顯示安藤忠雄的？", options: ["堅強意志與決心", "自大與傲慢", "無奈與妥協", "天真與浪漫"], answer: "堅強意志與決心", explanation: "這句話表達了他不畏艱難，決心在非主流的自學道路上闖出成就的意志。" });
            q.push({ id: id++, category: "課文解析", question: "文中引用「紙上得來終覺淺，絕知此事要躬行」意近於安藤的哪種經歷？", options: ["行萬里路(旅行體驗)", "自修苦讀", "考拳擊執照", "參加競圖"], answer: "行萬里路(旅行體驗)", explanation: "安藤透過旅行親身觸摸、體驗建築，比書本知識更深刻，印證了「讀萬卷書不如行萬里路」。" });
            q.push({ id: id++, category: "課文解析", question: "「你沒受過正規的教育，怎麼能成為一個建築家？」這句話運用了什麼修辭？", options: ["設問(激問)", "誇飾", "倒反", "譬喻"], answer: "設問(激問)", explanation: "這是激問（反問），答案在問題反面，強調旁人認為他「不能」成為建築家。" });
            q.push({ id: id++, category: "課文解析", question: "創業初期，安藤忠雄對於執行小案子的態度是？", options: ["懷著感恩的心", "感到委屈", "隨便應付", "拒絕接案"], answer: "懷著感恩的心", explanation: "即使是小案子，他也懷著感恩的心全力以赴，深信「有一就會有十」。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄認為「機會」是如何產生的？", options: ["要自己創造，主動發聲", "等待別人給予", "靠運氣", "靠政府補助"], answer: "要自己創造，主動發聲", explanation: "課文提到：「如果沒有發聲，就不會有任何機會」，機會必須自己創造。" });
            q.push({ id: id++, category: "課文解析", question: "「菁英分子不容易被說服」這句話暗示了什麼？", options: ["必須堅持己見，不斷溝通", "菁英都很固執", "不要跟菁英說話", "放棄溝通"], answer: "必須堅持己見，不斷溝通", explanation: "因為不容易說服，所以必須「一直說，一直說」，展現堅持與溝通的重要。" });
            q.push({ id: id++, category: "課文解析", question: "儘管學歷遭受質疑，安藤忠雄最終依然贏得了什麼？", options: ["日本社會的敬重", "更多的金錢", "政治地位", "拳擊冠軍"], answer: "日本社會的敬重", explanation: "實力戰勝了偏見，他依然贏得日本社會的敬重。" });
            q.push({ id: id++, category: "課文解析", question: "安藤忠雄將競圖視為「磨鍊思考」的場所，這呼應了他哪段經歷？", options: ["曾是拳擊手", "曾是木工", "曾是貨車司機", "曾是學生"], answer: "曾是拳擊手", explanation: "將競圖比喻為「拳擊場」，呼應了他年輕時曾擔任職業拳擊手的經歷。" });
            q.push({ id: id++, category: "課文解析", question: "「寶劍鋒從磨礪出，梅花香自苦寒來」最適合形容安藤忠雄的哪種精神？", options: ["歷經磨鍊終獲成功", "天資聰穎", "運氣很好", "喜歡冒險"], answer: "歷經磨鍊終獲成功", explanation: "安藤經過艱苦的自學與磨鍊，最終獲得成就，與此名句意境相符。" });
            q.push({ id: id++, category: "課文解析", question: "本課文的主旨是期勉讀者？", options: ["秉持熱情、自強不息", "追求名利", "考取證照", "出國旅遊"], answer: "秉持熱情、自強不息", explanation: "文章核心在於期勉讀者學習安藤忠雄追求夢想的熱情與堅持到底的精神。" });

            // 隨機打亂選項 (Fisher-Yates Shuffle)
            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // 對每一題的選項進行洗牌
            q.forEach(item => {
                item.options = shuffleArray(item.options);
            });

            return q;
        };

        const ALL_QUESTIONS = generateQuestions(); 

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'correct') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now);
                    osc.frequency.setValueAtTime(659.25, now + 0.1);
                    osc.frequency.setValueAtTime(783.99, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch (e) { console.error(e); }
        };

        const Confetti = () => {
            const colors = ['#F97316', '#EF4444', '#F59E0B', '#EC4899', '#FB923C', '#FCD34D'];
            const pieces = Array.from({ length: 50 }).map((_, i) => ({
                id: i, left: Math.random() * 100 + '%', animationDelay: Math.random() * 0.5 + 's', backgroundColor: colors[Math.floor(Math.random() * colors.length)], rotation: Math.random() * 360 + 'deg'
            }));
            return (
                <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
                    {pieces.map((p) => (
                        <div key={p.id} className="absolute w-3 h-3 md:w-4 md:h-4 opacity-0 animate-confetti" style={{ left: p.left, top: '-20px', backgroundColor: p.backgroundColor, transform: `rotate(${p.rotation})`, animation: `fall 2.5s ease-out forwards ${p.animationDelay}` }} />
                    ))}
                    <style>{`@keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }`}</style>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-screen bg-stone-50">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
                <p className="text-stone-600">載入中...</p>
            </div>
        );

        // --- Auth & Dashboard Components ---
        const AuthScreen = ({ onLogin }) => {
            const [name, setName] = useState('');
            const [savedName, setSavedName] = useState('');

            useEffect(() => {
                const user = LocalDB.getUser();
                if (user && user.displayName) {
                    setSavedName(user.displayName);
                }
            }, []);

            const handleLogin = (e, forcedName) => {
                if (e) e.preventDefault();
                const loginName = forcedName || name;
                if (!loginName.trim()) return;
                
                const user = LocalDB.saveUser(loginName);
                onLogin(user);
            };

            const handleQuickLogin = () => {
                const randomNum = Math.floor(Math.random() * 1000);
                const user = LocalDB.saveUser(`訪客 ${randomNum}`);
                onLogin(user);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-cyan-100 to-blue-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-cyan-500">
                        <div className="text-center mb-8">
                            <Brain className="w-16 h-16 text-cyan-600 mx-auto mb-4" />
                            <h1 className="text-3xl font-bold text-stone-800">安藤忠雄</h1>
                            <p className="text-stone-500 mt-2">字形、字音、字義辨正 App</p>
                        </div>
                        
                        {savedName && (
                            <div className="mb-6">
                                <button onClick={() => handleLogin(null, savedName)} className="w-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-4 rounded-xl font-bold hover:from-cyan-600 hover:to-blue-600 transition shadow-lg shadow-cyan-200 flex items-center justify-center group">
                                    <Sparkles className="w-5 h-5 mr-2 animate-pulse text-yellow-200" />
                                    <span>以 {savedName} 繼續學習</span>
                                    <ChevronRight className="w-5 h-5 ml-2 group-hover:translate-x-1 transition" />
                                </button>
                                <div className="text-center mt-3">
                                    <button onClick={() => { setSavedName(''); LocalDB.clearUser(); }} className="text-xs text-stone-400 hover:text-stone-600 underline">這不是我，切換帳號</button>
                                </div>
                            </div>
                        )}

                        <form onSubmit={handleLogin} className={`space-y-4 ${savedName ? 'hidden' : ''}`}>
                            <div>
                                <label className="block text-sm font-medium text-stone-700 mb-1">請輸入您的姓名</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Ex: 王小明" />
                            </div>
                            <button type="submit" disabled={!name.trim()} className="w-full bg-cyan-600 text-white py-3 rounded-lg font-semibold hover:bg-cyan-700 transition disabled:opacity-50">
                                開始學習
                            </button>
                        </form>
                        
                        <div className={`mt-4 flex items-center justify-between ${savedName ? 'hidden' : ''}`}>
                            <div className="h-px bg-stone-200 flex-1"></div><span className="text-sm text-stone-400 px-2">或</span><div className="h-px bg-stone-200 flex-1"></div>
                        </div>
                        <button onClick={handleQuickLogin} className={`mt-4 w-full bg-stone-50 border-2 border-stone-200 text-stone-600 py-3 rounded-lg font-semibold hover:bg-stone-100 transition flex items-center justify-center ${savedName ? 'hidden' : ''}`}>
                            <Zap className="w-5 h-5 mr-2 text-yellow-500" /> 快速體驗 (免輸入姓名)
                        </button>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout, onNavigate }) => {
            return (
                <div className="p-6 max-w-4xl mx-auto space-y-6">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-stone-800">歡迎回來，{user.displayName || "同學"}</h1>
                            <p className="text-stone-500">準備好精通文字與安藤忠雄的故事了嗎？</p>
                        </div>
                        <button onClick={onLogout} className="text-stone-500 hover:text-red-500 flex items-center">
                            <LogOut className="w-6 h-6 mr-1" /> <span className="text-sm">登出</span>
                        </button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onClick={() => onNavigate('learn')} className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-cyan-500 text-left col-span-1 md:col-span-2">
                            <div className="flex items-center space-x-4 mb-2">
                                <div className="bg-cyan-100 p-3 rounded-full group-hover:bg-cyan-200 transition"><BookOpen className="w-8 h-8 text-cyan-600" /></div>
                                <h2 className="text-xl font-bold text-stone-800">進入學習介面</h2>
                            </div>
                            <p className="text-stone-500 pl-16">瀏覽核心字彙、易混淆字形音義、成語與課文背景。</p>
                        </button>
                        
                        {/* 測驗區塊 */}
                        <div className="col-span-1 md:col-span-2 bg-stone-50 border-2 border-dashed border-stone-200 rounded-2xl p-4">
                            <h3 className="text-lg font-bold text-stone-600 mb-3 flex items-center"><Scale className="w-5 h-5 mr-2" /> 測驗挑戰區</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onClick={() => onNavigate('quiz_setup')} className="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition group border-l-4 border-emerald-500 text-left">
                                    <div className="flex items-center space-x-3 mb-1">
                                        <div className="bg-emerald-100 p-2 rounded-full group-hover:bg-emerald-200 transition"><PenTool className="w-6 h-6 text-emerald-600" /></div>
                                        <h2 className="text-lg font-bold text-stone-800">一般測驗</h2>
                                    </div>
                                    <p className="text-sm text-stone-500 pl-12">逐題作答，適合詳細練習。</p>
                                </button>
                                
                                <button onClick={() => onNavigate('quick_quiz')} className="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition group border-l-4 border-amber-500 text-left">
                                    <div className="flex items-center space-x-3 mb-1">
                                        <div className="bg-amber-100 p-2 rounded-full group-hover:bg-amber-200 transition"><FastForward className="w-6 h-6 text-amber-600" /></div>
                                        <h2 className="text-lg font-bold text-stone-800">快速測驗</h2>
                                    </div>
                                    <p className="text-sm text-stone-500 pl-12">列表模式，即時回饋刷題。</p>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4 mt-8">
                        <button onClick={() => onNavigate('history')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <History className="w-6 h-6 text-orange-500 mb-2" /><span className="text-sm font-medium text-stone-700">測驗紀錄</span>
                        </button>
                        <button onClick={() => onNavigate('mistakes')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <AlertCircle className="w-6 h-6 text-red-500 mb-2" /><span className="text-sm font-medium text-stone-700">錯題本</span>
                        </button>
                        <button onClick={() => onNavigate('favorites')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <Heart className="w-6 h-6 text-rose-500 mb-2" /><span className="text-sm font-medium text-stone-700">題目收藏</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- LearningModule ---
        const LearningModule = ({ onBack }) => {
            const [activeTab, setActiveTab] = useState('intro'); 
            
            const tabs = [
                { id: 'intro', label: '核心字彙(一)' },
                { id: 'shape_sound', label: '形音義(二)' },
                { id: 'idioms', label: '成語與詞語' },
                { id: 'knowledge', label: '課文背景' },
                { id: 'structure', label: '修辭鑑賞' },
            ];

            // Render Image Section - Modified to load local images
            const renderImageSection = (item, uniqueKey) => {
                const imagePath = `images/${uniqueKey}.jpg`;

                return (
                    <div className="mt-4 border-t border-dashed border-stone-200 pt-4">
                        <div className="relative group">
                            <img 
                                src={imagePath} 
                                alt="Illustration" 
                                className="w-full h-auto rounded-lg shadow-sm" 
                                onError={(e) => { e.target.style.display = 'none'; }} // Hide if not found
                            />
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={onBack} className="flex items-center text-stone-600 hover:text-cyan-600">
                                <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                            </button>
                            <div className="w-4"></div>
                        </div>
                        <h2 className="font-bold text-lg text-stone-800 hidden md:block">學習重點</h2>
                    </div>
                    
                    <div className="flex overflow-x-auto bg-stone-50 px-2 py-2 gap-2 sticky top-14 z-10 border-b">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${
                                    activeTab === tab.id 
                                        ? 'bg-cyan-600 text-white shadow-md' 
                                        : 'bg-white text-stone-600 hover:bg-cyan-50 border border-stone-200'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-stone-100 pb-20">
                        <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-sm p-6 min-h-[500px]">
                            
                            {activeTab === 'intro' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.intro.title}</h3>
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.intro.items.map((item, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white">
                                                <h4 className="font-bold text-xl text-cyan-700 mb-2">{item.term}</h4>
                                                <p className="text-stone-700 mb-3 text-lg leading-relaxed whitespace-pre-wrap">{item.definition}</p>
                                                {renderImageSection(item, `intro-${i}`)}
                                            </div>
                                        ))}
                                        {/* Special Block */}
                                        <div className="border-l-4 border-emerald-500 bg-emerald-50 p-6 rounded-r-xl">
                                            <h4 className="font-bold text-xl text-emerald-800 mb-4 flex items-center"><Lightbulb className="w-6 h-6 mr-2"/> {STUDY_CONTENT.intro.special_item.term}</h4>
                                            <p className="text-emerald-900 font-bold mb-4">{STUDY_CONTENT.intro.special_item.definition}</p>
                                            <div className="text-stone-700 leading-relaxed whitespace-pre-wrap text-sm bg-white/50 p-4 rounded-lg">
                                                {STUDY_CONTENT.intro.special_item.long_desc}
                                            </div>
                                            {renderImageSection(STUDY_CONTENT.intro.special_item, 'intro-special')}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'shape_sound' && (
                                <div className="space-y-8">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.shape_sound.title}</h3>
                                    
                                    <div>
                                        <h4 className="text-lg font-bold text-purple-700 mb-3 bg-purple-50 p-2 rounded w-fit">字形與字音系列</h4>
                                        <div className="grid gap-4">
                                            {STUDY_CONTENT.shape_sound.items.map((item, i) => (
                                                <div key={i} className="bg-white border border-purple-100 p-4 rounded-lg shadow-sm">
                                                    <div className="flex items-center mb-2">
                                                        <span className="text-2xl font-bold text-purple-800 mr-3 border-r pr-3 border-purple-200">{item.char}</span>
                                                    </div>
                                                    <p className="text-stone-700 whitespace-pre-wrap leading-relaxed">{item.content}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-rose-700 mb-3 bg-rose-50 p-2 rounded w-fit">形音辨正 (易混淆)</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {STUDY_CONTENT.shape_sound.confusing.map((item, i) => (
                                                <div key={i} className="flex justify-between items-center bg-white border border-stone-200 p-3 rounded-lg">
                                                    <span className="font-medium text-stone-800">{item.text}</span>
                                                    <span className="text-sm font-mono text-rose-600 bg-rose-50 px-2 py-1 rounded">{item.sounds}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'idioms' && (
                                <div className="space-y-8">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.idioms.title}</h3>
                                    
                                    <div>
                                        <h4 className="text-lg font-bold text-amber-700 mb-3 bg-amber-50 p-2 rounded w-fit flex items-center"><Leaf className="w-5 h-5 mr-2"/> 課文重點詞語</h4>
                                        <div className="grid gap-4">
                                            {STUDY_CONTENT.idioms.hope.map((item, i) => (
                                                <div key={i} className="bg-white border border-amber-100 p-5 rounded-xl shadow-sm">
                                                    <h5 className="font-bold text-lg text-amber-900 mb-2">{item.name}</h5>
                                                    <p className="text-stone-700 mb-2">{item.mean}</p>
                                                    {renderImageSection(item, `idiom-hope-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-blue-700 mb-3 bg-blue-50 p-2 rounded w-fit flex items-center"><Mountain className="w-5 h-5 mr-2"/> 進階詞語辨析</h4>
                                        <div className="grid gap-4">
                                            {STUDY_CONTENT.idioms.tree.map((item, i) => (
                                                <div key={i} className="bg-white border border-blue-100 p-5 rounded-xl shadow-sm">
                                                    <h5 className="font-bold text-lg text-blue-900 mb-2">{item.name}</h5>
                                                    <p className="text-stone-700">{item.mean}</p>
                                                    {renderImageSection(item, `idiom-tree-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-red-700 mb-3 bg-red-50 p-2 rounded w-fit">其他重要語詞</h4>
                                        <div className="grid gap-4">
                                            {STUDY_CONTENT.idioms.analysis.map((item, i) => (
                                                <div key={i} className="bg-white border-l-4 border-red-400 p-5 rounded shadow-sm">
                                                    <h5 className="font-bold text-lg text-red-900 mb-1">{item.name}</h5>
                                                    <p className="text-stone-700 mb-2 whitespace-pre-wrap leading-relaxed">{item.mean}</p>
                                                    {renderImageSection(item, `idiom-analysis-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'knowledge' && (
                                <div className="space-y-8">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.knowledge.title}</h3>
                                    
                                    <div>
                                        <h4 className="text-lg font-bold text-green-700 mb-3 bg-green-50 p-2 rounded w-fit">核心主旨與結構</h4>
                                        <div className="space-y-4">
                                            {STUDY_CONTENT.knowledge.concepts.map((item, i) => (
                                                <div key={i} className="bg-green-50/50 p-5 rounded-xl border border-green-100">
                                                    <h5 className="font-bold text-green-900 text-lg mb-1">{item.title} <span className="text-sm font-normal text-stone-500">({item.source})</span></h5>
                                                    <p className="text-stone-700 leading-relaxed whitespace-pre-wrap">{item.content}</p>
                                                    {renderImageSection(item, `know-concept-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-stone-700 mb-3 bg-stone-100 p-2 rounded w-fit">重點文意深究</h4>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {STUDY_CONTENT.knowledge.examples.map((item, i) => (
                                                <div key={i} className="bg-white border border-stone-200 p-5 rounded-xl shadow-sm">
                                                    <h5 className="font-bold text-stone-900 mb-2">{item.title}</h5>
                                                    <p className="text-stone-600 text-sm leading-relaxed whitespace-pre-wrap">{item.content}</p>
                                                    {renderImageSection(item, `know-ex-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-teal-700 mb-3 bg-teal-50 p-2 rounded w-fit">寫作手法分析</h4>
                                        <div className="space-y-2">
                                            {STUDY_CONTENT.knowledge.techniques.map((tech, i) => (
                                                <div key={i} className="bg-white p-4 rounded-lg border-l-4 border-teal-400 shadow-sm">
                                                    <h5 className="text-stone-800 font-bold mb-1">{tech.title}</h5>
                                                    <p className="text-stone-600 text-sm leading-relaxed">{tech.content}</p>
                                                    {renderImageSection(tech, `know-tech-${i}`)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'structure' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.structure.title}</h3>
                                    <div className="space-y-6">
                                        {STUDY_CONTENT.structure.parts.map((part, i) => (
                                            <div key={i} className="flex flex-col md:flex-row gap-4 bg-white border border-stone-200 p-6 rounded-xl shadow-sm hover:shadow-md transition">
                                                <div className="flex-1">
                                                    <span className="inline-block px-3 py-1 bg-stone-800 text-white text-xs rounded-full mb-3">{part.section}</span>
                                                    <h4 className="text-xl font-bold text-stone-900 mb-2">{part.title}</h4>
                                                    <p className="text-stone-600 leading-relaxed text-lg">{part.content}</p>
                                                </div>
                                                <div className="w-full md:w-1/3">
                                                    {renderImageSection(part, `structure-${i}`)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const FullQuizModule = ({ user, onBack, onComplete }) => {
            const [selectedCategory, setSelectedCategory] = useState(null); 
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [favorites, setFavorites] = useState(new Set());
            const [questions, setQuestions] = useState([]);
            const [isAnswered, setIsAnswered] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [hasSavedSession, setHasSavedSession] = useState(false);

            // Init Check for Saved Session
            useEffect(() => {
                const saved = LocalDB.getProgress(STORAGE_KEYS.QUIZ_PROGRESS_FULL);
                if (saved && saved.questions && saved.questions.length > 0) {
                    setHasSavedSession(true);
                }
            }, []);

            // Auto-save when state changes (if a quiz is active)
            useEffect(() => {
                if (selectedCategory && questions.length > 0) {
                    LocalDB.saveProgress(STORAGE_KEYS.QUIZ_PROGRESS_FULL, {
                        selectedCategory,
                        questions,
                        currentQuestionIndex,
                        answers
                    });
                }
            }, [selectedCategory, questions, currentQuestionIndex, answers]);

            useEffect(() => {
                if (!selectedCategory) return;
                
                // Only load new questions if we aren't resuming (resuming sets state directly)
                if (questions.length === 0) {
                    let filtered = [...ALL_QUESTIONS];
                    if (selectedCategory !== 'all') {
                        filtered = filtered.filter(q => q.category === selectedCategory);
                    }
                    filtered = filtered.sort(() => 0.5 - Math.random());
                    setQuestions(filtered);
                    setCurrentQuestionIndex(0);
                    setAnswers({});
                    setIsAnswered(false);
                }
            }, [selectedCategory]);

            useEffect(() => {
                const favSet = LocalDB.getFavorites();
                const intSet = new Set(Array.from(favSet).map(id => parseInt(id)));
                setFavorites(intSet);
            }, []);

            const handleResume = () => {
                const saved = LocalDB.getProgress(STORAGE_KEYS.QUIZ_PROGRESS_FULL);
                if (saved) {
                    setQuestions(saved.questions);
                    setAnswers(saved.answers);
                    setCurrentQuestionIndex(saved.currentQuestionIndex);
                    setSelectedCategory(saved.selectedCategory);
                    
                    // Determine if current question is already answered
                    if (saved.answers[saved.questions[saved.currentQuestionIndex].id]) {
                        setIsAnswered(true);
                    }
                }
            };

            const toggleFavorite = (qId) => {
                const newFavs = LocalDB.toggleFavorite(qId);
                const intSet = new Set(Array.from(newFavs).map(id => parseInt(id)));
                setFavorites(intSet);
            };

            const handleAnswer = (option) => {
                if (isAnswered) return; 
                const currentQ = questions[currentQuestionIndex];
                const isCorrect = option === currentQ.answer;
                setAnswers(prev => ({ ...prev, [currentQ.id]: option }));
                setIsAnswered(true);
                if (isCorrect) {
                    playSound('correct');
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 2500);
                } else {
                    playSound('incorrect');
                }
            };

            const handleSubmit = () => {
                if (isSubmitting) return; 
                setIsSubmitting(true);
                try {
                    let score = 0;
                    const details = questions.map(q => {
                        const isCorrect = answers[q.id] === q.answer;
                        if (isCorrect) score += 1;
                        return {
                            id: q.id,
                            question: q.question,
                            userAnswer: answers[q.id],
                            correctAnswer: q.answer,
                            isCorrect,
                            options: q.options,
                            category: q.category,
                            explanation: q.explanation // Save explanation for history/review
                        };
                    });
                    
                    LocalDB.addHistory({
                        score: Math.round((score / questions.length) * 100),
                        total: questions.length,
                        category: selectedCategory === 'all' ? '綜合挑戰' : selectedCategory,
                        details: details
                    });

                    for (const detail of details) {
                        if (!detail.isCorrect) {
                            LocalDB.addMistake({
                                id: detail.id,
                                question: detail.question,
                                answer: detail.correctAnswer,
                                category: detail.category,
                                explanation: detail.explanation
                            });
                        }
                    }

                    // Clear progress on completion
                    LocalDB.clearProgress(STORAGE_KEYS.QUIZ_PROGRESS_FULL);

                    onComplete({ score: Math.round((score / questions.length) * 100), details });
                } catch (error) {
                    console.error(error);
                    alert("儲存成績時發生錯誤");
                    setIsSubmitting(false); 
                }
            };

            if (!selectedCategory) {
                // Updated categories for the new content
                const categories = [
                    { id: '形音義', label: '字形字音字義', icon: <PenTool className="w-6 h-6 text-purple-500"/>, desc: '契、古、肖等系列字辨析' },
                    { id: '成語', label: '成語與詞語', icon: <List className="w-6 h-6 text-amber-500"/>, desc: '重要詞語與成語測驗' },
                    { id: '課文解析', label: '安藤忠雄篇', icon: <Hammer className="w-6 h-6 text-emerald-500"/>, desc: '課文內容、結構與修辭' },
                    { id: 'all', label: '全範圍綜合挑戰', icon: <Zap className="w-6 h-6 text-yellow-500"/>, desc: '包含所有單元的綜合測驗', isAll: true },
                ];
                return (
                    <div className="h-full flex flex-col bg-stone-50">
                        <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10">
                            <button onClick={onBack} className="flex items-center text-stone-600 hover:text-cyan-600 mr-4">
                                <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                            </button>
                            <h2 className="font-bold text-lg text-stone-800">選擇測驗單元</h2>
                        </div>
                        
                        <div className="p-6 overflow-y-auto">
                            {hasSavedSession && (
                                <div className="max-w-4xl mx-auto mb-6">
                                    <button onClick={handleResume} className="w-full bg-stone-800 text-white p-4 rounded-xl shadow-lg hover:bg-stone-700 transition flex items-center justify-center animate-pulse">
                                        <RotateCcw className="w-5 h-5 mr-2 text-emerald-400" />
                                        <span className="font-bold text-lg">繼續上次未完成的測驗</span>
                                    </button>
                                </div>
                            )}
                            
                            <div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                                {categories.map(cat => (
                                    <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`text-left p-6 rounded-2xl shadow-sm border-2 transition hover:shadow-md flex items-start ${cat.isAll ? 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-200 hover:border-yellow-400' : 'bg-white border-stone-100 hover:border-cyan-200'}`}>
                                        <div className={`p-3 rounded-full mr-4 ${cat.isAll ? 'bg-white shadow-sm' : 'bg-stone-50'}`}>{cat.icon}</div>
                                        <div>
                                            <h3 className={`font-bold text-lg mb-1 ${cat.isAll ? 'text-yellow-800' : 'text-stone-800'}`}>{cat.label}</h3>
                                            <p className="text-sm text-stone-500">{cat.desc}</p>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (questions.length === 0) return <LoadingScreen />;
            const currentQ = questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            
            return (
                <div className="h-full flex flex-col bg-stone-50 relative">
                    {showConfetti && <Confetti />}
                    <div className="bg-white shadow-sm px-4 py-3 flex items-center justify-between z-10">
                        <div className="flex items-center"><button onClick={onBack} className="flex items-center text-stone-500 hover:text-cyan-600 mr-4 px-3 py-1 rounded-full hover:bg-stone-50 transition border border-transparent hover:border-stone-200"><Home className="w-4 h-4 mr-1" /> <span className="text-sm font-medium">首頁</span></button><div className="flex items-center text-stone-500 border-l pl-4"><span className="font-mono text-lg font-bold text-cyan-600 mr-2">{currentQuestionIndex + 1}</span><span className="text-sm">/ {questions.length}</span></div></div>
                        <div className="flex-1 mx-4 h-2 bg-stone-200 rounded-full overflow-hidden max-w-xs md:max-w-md hidden md:block"><div className="h-full bg-cyan-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div>
                        <button onClick={() => toggleFavorite(currentQ.id)} className={`p-2 rounded-full hover:bg-stone-100 transition`}><Heart className={`w-6 h-6 transition-colors duration-300 ${favorites.has(currentQ.id) ? 'fill-rose-500 text-rose-500' : 'text-stone-400'}`} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col items-center">
                        <div className="w-full max-w-2xl flex-1">
                            <div className="bg-white rounded-2xl shadow-lg p-6 md:p-10 mb-6 relative">
                                <span className="inline-block px-3 py-1 bg-cyan-100 text-cyan-700 text-xs font-bold rounded-full mb-4">{currentQ.category}</span>
                                <h3 className="text-xl md:text-2xl font-bold text-stone-800 mb-8 leading-relaxed">{currentQ.question}</h3>
                                <div className="space-y-3">{currentQ.options.map((opt, i) => {
                                    let statusClass = "border-stone-100 hover:border-stone-300 text-stone-700";
                                    if (isAnswered) { if (opt === currentQ.answer) { statusClass = "border-emerald-500 bg-emerald-50 text-emerald-900 font-bold"; } else if (opt === answers[currentQ.id]) { statusClass = "border-red-500 bg-red-50 text-red-900"; } else { statusClass = "border-stone-100 opacity-50"; } }
                                    return (<button key={i} onClick={() => handleAnswer(opt)} disabled={isAnswered} className={`w-full text-left p-5 rounded-xl border-2 transition relative text-lg font-medium ${statusClass}`}><span className="inline-block w-6 font-bold text-stone-400 mr-2">{String.fromCharCode(65 + i)}.</span>{opt}{isAnswered && opt === currentQ.answer && <CheckCircle className="w-5 h-5 text-emerald-600 absolute right-4 top-1/2 -translate-y-1/2" />}{isAnswered && opt === answers[currentQ.id] && opt !== currentQ.answer && <XCircle className="w-5 h-5 text-red-600 absolute right-4 top-1/2 -translate-y-1/2" />}</button>);
                                })}</div>
                            </div>
                            
                            {/* Updated Immediate Explanation Section for Full Quiz */}
                            {isAnswered && (
                                <div className={`rounded-xl p-6 mb-6 animate-fade-in ${answers[currentQ.id] === currentQ.answer ? 'bg-emerald-50 text-emerald-900' : 'bg-red-50 text-red-900'}`}>
                                    <div className="flex items-center mb-2 font-bold text-lg">
                                        {answers[currentQ.id] === currentQ.answer ? <><CheckCircle className="w-6 h-6 mr-2" /> 答對了！</> : <><XCircle className="w-6 h-6 mr-2" /> 答錯了！</>}
                                    </div>
                                    <div className="mt-2 text-xl mb-3"><span className="font-bold">正確答案：</span> {currentQ.answer}</div>
                                    
                                    {/* Explanation Block */}
                                    <div className="bg-white/60 rounded-lg p-4 text-stone-800 text-lg leading-relaxed border border-black/5">
                                        <div className="flex items-center font-bold text-stone-700 mb-1">
                                            <Info className="w-5 h-5 mr-1" /> 詳解：
                                        </div>
                                        {currentQ.explanation}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-white p-4 border-t flex justify-between items-center z-10 sticky bottom-0">
                        <div className="w-24"></div> 
                        {isAnswered ? (currentQuestionIndex < questions.length - 1 ? (<button onClick={() => { setIsAnswered(false); setShowConfetti(false); setCurrentQuestionIndex(c => c + 1); }} className="px-8 py-3 bg-stone-800 text-white rounded-full hover:bg-stone-700 transition font-bold shadow-lg flex items-center animate-bounce-subtle">下一題 <ChevronRight className="w-5 h-5 ml-1" /></button>) : (<button onClick={handleSubmit} disabled={isSubmitting} className="px-8 py-3 bg-cyan-600 text-white rounded-full hover:bg-cyan-700 transition font-bold shadow-lg shadow-cyan-200 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">{isSubmitting ? <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> 處理中...</> : <>查看總成績 <CheckCircle className="w-5 h-5 ml-2" /></>}</button>)) : (<div className="text-stone-400 text-sm italic">請選擇一個答案以繼續</div>)}<div className="w-24"></div>
                    </div>
                </div>
            );
        };

        const QuickQuizModule = ({ onBack, onComplete }) => {
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);
            const [favorites, setFavorites] = useState(new Set());
            const [showConfetti, setShowConfetti] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showResumeDialog, setShowResumeDialog] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                const initQuiz = () => {
                    const saved = LocalDB.getProgress(STORAGE_KEYS.QUIZ_PROGRESS_QUICK);
                    if (saved && saved.questions && saved.questions.length > 0) {
                        setShowResumeDialog(true);
                        // Store temp data to state just in case, but rely on dialog choice
                        return;
                    } 
                    startNewQuiz();
                };
                
                // Initialize Favorites
                const favSet = LocalDB.getFavorites();
                const intSet = new Set(Array.from(favSet).map(id => parseInt(id)));
                setFavorites(intSet);

                initQuiz();
            }, []);

            // Save progress whenever answers change
            useEffect(() => {
                if (questions.length > 0 && Object.keys(answers).length > 0) {
                    LocalDB.saveProgress(STORAGE_KEYS.QUIZ_PROGRESS_QUICK, {
                        questions, // Must save order
                        answers,
                        score
                    });
                }
            }, [answers, score, questions]);

            const startNewQuiz = () => {
                const shuffled = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random());
                setQuestions(shuffled);
                setAnswers({});
                setScore(0);
                LocalDB.clearProgress(STORAGE_KEYS.QUIZ_PROGRESS_QUICK);
            };

            const resumeQuiz = () => {
                const saved = LocalDB.getProgress(STORAGE_KEYS.QUIZ_PROGRESS_QUICK);
                if (saved) {
                    setQuestions(saved.questions);
                    setAnswers(saved.answers);
                    setScore(saved.score);
                }
                setShowResumeDialog(false);
            };

            const toggleFavorite = (qId) => {
                const newFavs = LocalDB.toggleFavorite(qId);
                const intSet = new Set(Array.from(newFavs).map(id => parseInt(id)));
                setFavorites(intSet);
            };

            const handleAnswer = (qId, option, correctAns, category, questionText, explanation) => {
                if (answers[qId]) return; // Already answered

                const isCorrect = option === correctAns;
                setAnswers(prev => ({ ...prev, [qId]: option }));
                
                if (isCorrect) {
                    playSound('correct');
                    setScore(prev => prev + 1);
                } else {
                    playSound('incorrect');
                    // Immediate Mistake Recording
                    LocalDB.addMistake({
                        id: qId,
                        question: questionText,
                        answer: correctAns,
                        category: category,
                        explanation: explanation
                    });
                }
            };

            const handleFinish = () => {
                if (isSubmitting) return;
                setIsSubmitting(true);
                
                // Calculate detailed results for history
                const details = questions.filter(q => answers[q.id]).map(q => ({
                    id: q.id,
                    question: q.question,
                    userAnswer: answers[q.id],
                    correctAnswer: q.answer,
                    isCorrect: answers[q.id] === q.answer,
                    options: q.options,
                    category: q.category,
                    explanation: q.explanation
                }));

                if (details.length > 0) {
                      LocalDB.addHistory({
                        score: Math.round((score / questions.length) * 100), 
                        total: questions.length, 
                        category: '快速測驗 (列表)',
                        details: details
                    });
                }
                
                // Clear saved progress
                LocalDB.clearProgress(STORAGE_KEYS.QUIZ_PROGRESS_QUICK);

                onComplete({ 
                    score: Math.round((score / questions.length) * 100), 
                    details: details.length > 0 ? details : [] 
                });
            };

            if (showResumeDialog) {
                return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl animate-fade-in text-center">
                            <div className="bg-amber-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <History className="w-8 h-8 text-amber-600" />
                            </div>
                            <h3 className="text-xl font-bold text-stone-800 mb-2">發現未完成的測驗</h3>
                            <p className="text-stone-500 mb-6">您上次還有未完成的快速測驗進度，是否要繼續？</p>
                            <div className="flex gap-3">
                                <button onClick={() => { setShowResumeDialog(false); startNewQuiz(); }} className="flex-1 py-3 border-2 border-stone-200 text-stone-600 rounded-xl font-bold hover:bg-stone-50 transition">
                                    重新開始
                                </button>
                                <button onClick={resumeQuiz} className="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition shadow-lg shadow-amber-200">
                                    繼續測驗
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (questions.length === 0) return <LoadingScreen />;

            return (
                <div className="h-full flex flex-col bg-stone-100">
                    {/* Header */}
                    <div className="bg-white shadow-md border-b px-4 py-3 flex items-center justify-between sticky top-0 z-20">
                         <div className="flex items-center">
                            <button onClick={onBack} className="flex items-center text-stone-600 hover:text-cyan-600 mr-4">
                                <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                            </button>
                            <h2 className="font-bold text-lg text-amber-600 flex items-center"><FastForward className="w-5 h-5 mr-2" /> 快速測驗模式</h2>
                        </div>
                        <div className="bg-stone-800 text-white px-4 py-1.5 rounded-full font-mono font-bold shadow-inner flex items-center">
                            <span className="text-emerald-400 mr-2">答對: {score}</span> <span className="text-stone-500 text-xs mx-1">/</span> <span className="text-stone-300">總題數: {questions.length}</span>
                        </div>
                    </div>

                    {/* Question List */}
                    <div className="flex-1 overflow-y-auto p-4 md:p-6" ref={scrollRef}>
                        <div className="max-w-3xl mx-auto space-y-6">
                            {questions.map((q, index) => {
                                const userAnswer = answers[q.id];
                                const isAnswered = !!userAnswer;
                                const isCorrect = userAnswer === q.answer;
                                
                                return (
                                    <div key={q.id} className={`bg-white rounded-xl shadow-sm border-l-4 p-5 transition-all ${isAnswered ? (isCorrect ? 'border-emerald-500 bg-emerald-50/30' : 'border-red-500 bg-red-50/30') : 'border-stone-200 hover:border-amber-300'}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-center">
                                                <span className="bg-stone-100 text-stone-500 text-xs font-bold px-2 py-1 rounded mr-2">#{index + 1}</span>
                                                <span className="bg-cyan-50 text-cyan-700 text-xs font-bold px-2 py-1 rounded">{q.category}</span>
                                            </div>
                                            <button onClick={() => toggleFavorite(q.id)} className="text-stone-300 hover:text-rose-500 transition">
                                                 <Heart className={`w-5 h-5 ${favorites.has(q.id) ? 'fill-rose-500 text-rose-500' : ''}`} />
                                            </button>
                                        </div>

                                        <h3 className="text-lg font-bold text-stone-800 mb-4">{q.question}</h3>

                                        <div className="grid grid-cols-1 gap-3">
                                            {q.options.map((opt, i) => {
                                                let btnClass = "border-stone-200 text-stone-600 hover:bg-stone-50";
                                                let icon = null;

                                                if (isAnswered) {
                                                    if (opt === q.answer) {
                                                        btnClass = "border-emerald-500 bg-emerald-100 text-emerald-800 font-bold ring-2 ring-emerald-200";
                                                        icon = <CheckCircle className="w-5 h-5 ml-auto text-emerald-600" />;
                                                    } else if (opt === userAnswer) { // Wrong answer selected
                                                        btnClass = "border-red-500 bg-red-100 text-red-800 font-bold";
                                                        icon = <XCircle className="w-5 h-5 ml-auto text-red-600" />;
                                                    } else {
                                                        btnClass = "border-stone-100 text-stone-400 opacity-50";
                                                    }
                                                }

                                                return (
                                                    <button 
                                                        key={i} 
                                                        onClick={() => handleAnswer(q.id, opt, q.answer, q.category, q.question, q.explanation)}
                                                        disabled={isAnswered}
                                                        className={`text-left px-4 py-3 rounded-lg border-2 transition flex items-center ${btnClass}`}
                                                    >
                                                        <span className="font-mono mr-2 opacity-50">{String.fromCharCode(65 + i)}.</span>
                                                        <span className="flex-1">{opt}</span>
                                                        {icon}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        
                                        {/* Updated Feedback Text with Explanation for Quick Quiz */}
                                        {isAnswered && (
                                            <div className={`mt-4 p-4 rounded-lg text-sm animate-fade-in ${isCorrect ? 'bg-emerald-100/50 text-emerald-900' : 'bg-red-50 text-red-900'}`}>
                                                <div className="flex items-center font-bold mb-2">
                                                    {isCorrect 
                                                        ? <><CheckCircle className="w-4 h-4 mr-1" /> 答對了！</> 
                                                        : <><AlertCircle className="w-4 h-4 mr-1" /> 答錯了！正確答案是：{q.answer}</>
                                                    }
                                                </div>
                                                <div className="text-stone-700 leading-relaxed border-t border-black/5 pt-2 mt-2">
                                                    <span className="font-bold block mb-1">詳解：</span>
                                                    {q.explanation}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Finish Button Area */}
                        <div className="max-w-3xl mx-auto mt-8 mb-10">
                            <button 
                                onClick={handleFinish} 
                                className="w-full bg-stone-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-stone-700 transition flex items-center justify-center text-lg"
                            >
                                <CheckCircle className="w-6 h-6 mr-2 text-emerald-400" /> 結束測驗並查看結果
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ResultReview = ({ result, onExit }) => {
            return (
                <div className="h-full bg-stone-50 overflow-y-auto">
                    <div className="max-w-3xl mx-auto p-6">
                        <div className="bg-white rounded-3xl shadow-lg p-8 mb-8 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-500 to-blue-500"></div>
                            <h2 className="text-3xl font-bold text-stone-800 mb-2">測驗結果</h2>
                            <div className="text-6xl font-black text-cyan-600 my-4">{result.score}<span className="text-2xl text-stone-400 font-normal">分</span></div>
                            <div className="flex justify-center gap-4 text-sm text-stone-500">
                                <span>總題數: {result.details.length}</span>
                                <span className="text-green-600">答對: {result.details.filter(d => d.isCorrect).length}</span>
                                <span className="text-red-500">答錯: {result.details.filter(d => !d.isCorrect).length}</span>
                            </div>
                            <button onClick={onExit} className="mt-8 px-8 py-2 border border-stone-300 rounded-full hover:bg-stone-50 transition">
                                返回首頁
                            </button>
                        </div>

                        <h3 className="text-xl font-bold text-stone-800 mb-4 px-2">試題解析</h3>
                        <div className="space-y-4">
                            {result.details.length === 0 ? <p className="text-center text-stone-500 py-4">本次測驗未作答任何題目。</p> : null}
                            {result.details.map((item, i) => (
                                <div key={i} className={`bg-white rounded-xl shadow-sm p-6 border-l-4 ${item.isCorrect ? 'border-emerald-500' : 'border-red-500'}`}>
                                    <div className="flex items-start justify-between mb-3">
                                        <h4 className="font-bold text-lg text-stone-800 flex-1">{i + 1}. {item.question}</h4>
                                        {item.isCorrect 
                                            ? <CheckCircle className="w-6 h-6 text-emerald-500 flex-shrink-0" />
                                            : <XCircle className="w-6 h-6 text-red-500 flex-shrink-0" />
                                        }
                                    </div>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex items-center">
                                            <span className="w-20 text-stone-500">您的答案：</span>
                                            <span className={`font-bold ${item.isCorrect ? 'text-emerald-700' : 'text-red-600'}`}>
                                                {item.userAnswer || '(未作答)'}
                                            </span>
                                        </div>
                                        {!item.isCorrect && (
                                            <div className="flex items-center">
                                                <span className="w-20 text-stone-500">正確答案：</span>
                                                <span className="font-bold text-emerald-700">{item.correctAnswer}</span>
                                            </div>
                                        )}
                                    </div>
                                    {/* Explanation in Review */}
                                    {item.explanation && (
                                        <div className="mt-4 bg-stone-50 p-3 rounded text-stone-700 text-sm leading-relaxed border border-stone-200">
                                            <span className="font-bold text-stone-900 block mb-1">解析：</span>
                                            {item.explanation}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ title, type, user, onBack }) => {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expandedId, setExpandedId] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    let data = [];
                    
                    if (type === 'history') {
                        data = LocalDB.getHistory();
                    } else if (type === 'mistakes') {
                        data = LocalDB.getMistakes();
                    } else if (type === 'favorites') {
                        const favSet = LocalDB.getFavorites();
                        const favIds = Array.from(favSet).map(id => parseInt(id));
                        data = ALL_QUESTIONS.filter(q => favIds.includes(q.id));
                    }

                    setItems(data);
                    setLoading(false);
                };
                fetchData();
            }, [user, type]);

            if (loading) return <LoadingScreen />;

            return (
                <div className="h-full bg-stone-50 flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10">
                        <button onClick={onBack} className="flex items-center text-stone-600 hover:text-cyan-600 mr-4">
                            <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                        </button>
                        <h2 className="font-bold text-lg">{title}</h2>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-6">
                        <div className="max-w-3xl mx-auto space-y-4">
                            {items.length === 0 && (
                                <div className="text-center py-20 text-stone-400">
                                    <p>目前沒有紀錄</p>
                                </div>
                            )}

                            {/* History Item */}
                            {type === 'history' && items.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition">
                                    <div 
                                        className="flex justify-between items-center cursor-pointer" 
                                        onClick={() => setExpandedId(expandedId === item.id ? null : item.id)}
                                    >
                                        <div>
                                            <div className="text-stone-500 text-xs mb-1">
                                                {item.date ? new Date(item.date).toLocaleString() : 'Just now'}
                                            </div>
                                            <div className="font-bold text-stone-800 flex items-center">
                                                <span className="mr-2 text-sm bg-stone-100 px-2 py-0.5 rounded text-stone-600">
                                                    {item.category || '綜合挑戰'}
                                                </span>
                                                測驗得分：
                                                <span className={`text-lg ml-1 ${item.score >= 80 ? 'text-emerald-600' : 'text-orange-600'}`}>
                                                    {item.score}
                                                </span> 分
                                            </div>
                                        </div>
                                        {expandedId === item.id ? (
                                            <ChevronUp className="w-5 h-5 text-stone-400" />
                                        ) : (
                                            <ChevronDown className="w-5 h-5 text-stone-400" />
                                        )}
                                    </div>
                                    
                                    {/* Enhanced Detail View for History */}
                                    {expandedId === item.id && (
                                        <div className="mt-4 pt-4 border-t border-stone-100 space-y-4">
                                            {item.details.map((d, i) => (
                                                <div key={i} className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                                                    {/* Question Header */}
                                                    <div className="flex items-start mb-3">
                                                        <span className="font-mono font-bold text-orange-600 mr-2 mt-0.5">{i+1}.</span>
                                                        <h4 className="font-bold text-stone-800 text-lg leading-snug flex-1">
                                                            {d.question}
                                                        </h4>
                                                        {d.isCorrect 
                                                            ? <CheckCircle className="w-5 h-5 text-emerald-500 flex-shrink-0 ml-2" />
                                                            : <XCircle className="w-5 h-5 text-red-500 flex-shrink-0 ml-2" />
                                                        }
                                                    </div>

                                                    {/* Options Display */}
                                                    <div className="space-y-1 mb-3 pl-6">
                                                        {d.options && d.options.map((opt, idx) => {
                                                            let optionStyle = "text-stone-600";
                                                            let icon = null;

                                                            if (opt === d.correctAnswer) {
                                                                optionStyle = "bg-emerald-100 text-emerald-800 font-bold border-emerald-200";
                                                                icon = <CheckCircle className="w-4 h-4 ml-2 inline" />;
                                                            } else if (opt === d.userAnswer && !d.isCorrect) {
                                                                optionStyle = "bg-red-50 text-red-800 line-through border-red-100";
                                                                icon = <XCircle className="w-4 h-4 ml-2 inline" />;
                                                            }

                                                            return (
                                                                <div key={idx} className={`px-3 py-2 rounded text-sm border border-transparent ${optionStyle} flex items-center`}>
                                                                    <span className="font-mono w-5 opacity-50 mr-1">{String.fromCharCode(65 + idx)}.</span>
                                                                    <span className="flex-1">{opt}</span>
                                                                    {icon}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>

                                                    {/* Analysis / Feedback Section */}
                                                    <div className="bg-white p-3 rounded border border-stone-100 text-sm mt-2 pl-6 relative">
                                                        <div className="absolute left-0 top-0 bottom-0 w-1 bg-orange-400 rounded-l"></div>
                                                        <div className="flex flex-col sm:flex-row gap-y-1 sm:gap-x-6 text-sm mb-1">
                                                            <div>
                                                                <span className="text-stone-400 mr-2">您的作答:</span>
                                                                <span className={`font-bold ${d.isCorrect ? 'text-emerald-600' : 'text-red-600'}`}>
                                                                    {d.userAnswer || '未作答'}
                                                                </span>
                                                            </div>
                                                            {!d.isCorrect && (
                                                                <div>
                                                                    <span className="text-stone-400 mr-2">正確答案:</span>
                                                                    <span className="font-bold text-emerald-600">{d.correctAnswer}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        {/* History Explanation */}
                                                        {d.explanation && (
                                                            <div className="mt-2 pt-2 border-t border-stone-100 text-stone-600 leading-relaxed">
                                                                <span className="font-bold text-stone-800">解析：</span>{d.explanation}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}

                            {/* Mistakes & Favorites List */}
                            {(type === 'mistakes' || type === 'favorites') && items.map((item) => (
                                <div key={item.id} className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-400">
                                    <div className="flex justify-between mb-3">
                                        <span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">{item.category || (ALL_QUESTIONS.find(q=>q.id === item.id)?.category)}</span>
                                        {type === 'mistakes' ? (
                                            <span className="text-xs text-red-500 font-bold">答錯</span>
                                        ) : (
                                            <Heart className="w-5 h-5 fill-rose-500 text-rose-500" />
                                        )}
                                    </div>
                                    <h3 className="font-bold text-lg text-stone-800 mb-3">{item.question}</h3>
                                    <div className="bg-emerald-50 p-3 rounded text-sm text-emerald-800 mb-3">
                                        <span className="font-bold">正確答案：</span> {item.answer || (ALL_QUESTIONS.find(q=>q.id === item.id)?.answer)}
                                    </div>
                                    
                                    {/* Explanation in Mistakes */}
                                    {(item.explanation || ALL_QUESTIONS.find(q=>q.id === item.id)?.explanation) && (
                                        <div className="bg-stone-50 p-3 rounded text-sm text-stone-600 leading-relaxed border border-stone-200">
                                            <span className="font-bold text-stone-800 block mb-1">解析：</span>
                                            {item.explanation || ALL_QUESTIONS.find(q=>q.id === item.id)?.explanation}
                                        </div>
                                    )}
                                    
                                    {/* Controls for removal */}
                                    <div className="mt-4 flex justify-end">
                                        {type === 'mistakes' && (
                                            <button 
                                                onClick={async (e) => {
                                                    e.target.innerText = "已移除";
                                                    e.target.disabled = true;
                                                    LocalDB.removeMistake(item.id);
                                                }}
                                                className="text-sm text-stone-400 hover:text-red-500 flex items-center"
                                            >
                                                <CheckCircle className="w-4 h-4 mr-1"/> 我學會了（移除）
                                            </button>
                                        )}
                                        {type === 'favorites' && (
                                            <button 
                                                onClick={async (e) => {
                                                    e.target.innerText = "已取消收藏";
                                                    e.target.disabled = true;
                                                    LocalDB.removeFavorite(item.id);
                                                }}
                                                className="text-sm text-stone-400 hover:text-red-500 flex items-center"
                                            >
                                                <Heart className="w-4 h-4 mr-1"/> 取消收藏
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth'); 
            const [loading, setLoading] = useState(true);
            const [quizResult, setQuizResult] = useState(null);

            useEffect(() => {
                const checkLogin = () => {
                    const savedUser = LocalDB.getUser();
                    if (savedUser) {
                        setUser(savedUser);
                        setView('dashboard');
                    } else {
                        setUser(null);
                        setView('auth');
                    }
                    setLoading(false);
                };
                checkLogin();
            }, []);

            if (loading) return <LoadingScreen />;

            if (view === 'auth') return <AuthScreen onLogin={(u) => { setUser(u); setView('dashboard'); }} />;
            if (view === 'dashboard') return <Dashboard user={user} onLogout={() => { setUser(null); setView('auth'); }} onNavigate={setView} />;
            if (view === 'learn') return <LearningModule onBack={() => setView('dashboard')} />;
            if (view === 'quiz_setup') {
                return <FullQuizModule user={user} onBack={() => setView('dashboard')} onComplete={(res) => { setQuizResult(res); setView('quiz_result'); }} />;
            }
            if (view === 'quick_quiz') {
                 return <QuickQuizModule onBack={() => setView('dashboard')} onComplete={(res) => { setQuizResult(res); setView('quiz_result'); }} />;
            }
            if (view === 'quiz_result') return <ResultReview result={quizResult} onExit={() => setView('dashboard')} />;
            if (view === 'history') return <ListView title="測驗歷史紀錄" type="history" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'mistakes') return <ListView title="錯題本 (尚未掌握)" type="mistakes" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'favorites') return <ListView title="我的題目收藏" type="favorites" user={user} onBack={() => setView('dashboard')} />;

            return <div className="p-4 text-center">未知頁面</div>;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>